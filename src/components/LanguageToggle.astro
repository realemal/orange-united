---
// Language toggle component - Simple localStorage-based toggle
---

<div class="language-toggle">
  <button
    id="lang-toggle"
    type="button"
    class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-gray-700 hover:text-orange-500 transition-colors rounded-lg hover:bg-orange-50 border border-gray-200"
    aria-label="Toggle language"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
    </svg>
    <span id="current-lang" class="min-w-[2rem] text-center">EN</span>
  </button>
</div>

<script is:inline>
  // Language toggle button - works with translate.js
  (function() {
    'use strict';
    
    const STORAGE_KEY = 'orange-united-language';
    
    function getCurrentLanguage() {
      try {
        return localStorage.getItem(STORAGE_KEY) || 'en';
      } catch (e) {
        return 'en';
      }
    }

    function setLanguage(lang) {
      try {
        const oldLang = getCurrentLanguage();
        localStorage.setItem(STORAGE_KEY, lang);
        
        // Dispatch custom event for immediate update
        window.dispatchEvent(new CustomEvent('languageChanged', { 
          detail: { language: lang } 
        }));
        
        // Trigger storage event for cross-tab synchronization
        // Note: StorageEvent only fires in OTHER tabs, not the current one
        // So we manually apply translations here
        applyTranslations(lang);
      } catch (e) {
        console.warn('Could not save language preference');
      }
    }
    
    function applyTranslations(lang) {
      // Update HTML lang attribute
      if (document.documentElement) {
        document.documentElement.setAttribute('lang', lang);
      }
      
      // Update button display
      const langSpan = document.getElementById('current-lang');
      if (langSpan) {
        langSpan.textContent = lang.toUpperCase();
      }
      
      // Apply translations to all elements
      document.querySelectorAll('[data-en][data-es]').forEach((el) => {
        if (el instanceof HTMLElement) {
          if (lang === 'es' && el.dataset.es) {
            el.textContent = el.dataset.es;
          } else if (el.dataset.en) {
            el.textContent = el.dataset.en;
          }
        }
      });
    }

    function handleToggle(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      const currentLang = getCurrentLanguage();
      const newLang = currentLang === 'en' ? 'es' : 'en';
      setLanguage(newLang);
      return false;
    }

    // Initialize button
    function init() {
      const toggleButton = document.getElementById('lang-toggle');
      if (toggleButton) {
        // Remove existing listeners by cloning
        const newButton = toggleButton.cloneNode(true);
        toggleButton.parentNode?.replaceChild(newButton, toggleButton);
        
        // Add click handler
        newButton.addEventListener('click', handleToggle);
      }
      
      // Update button display with current language
      const langSpan = document.getElementById('current-lang');
      if (langSpan) {
        langSpan.textContent = getCurrentLanguage().toUpperCase();
      }
    }

    // Run when ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

